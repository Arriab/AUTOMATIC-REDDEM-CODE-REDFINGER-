<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kode Redeem Manager</title>
<style>
body {
    font-family: monospace;
    background: #f5f5f5;
    display: flex;
    justify-content: center;
    padding: 40px 20px;
}
.container {
    background: #fff;
    padding: 25px;
    border-radius: 10px;
    width: 100%;
    max-width: 700px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}
select, textarea, input, button {
    padding: 10px;
    width: 100%;
    margin: 5px 0;
    border-radius: 5px;
    border: 1px solid #ccc;
    box-sizing: border-box;
    font-size: 14px;
    font-family: monospace;
}
textarea { height: 100px; }
button {
    cursor: pointer;
    background: #4CAF50;
    color: white;
    border: none;
}
button:hover { background: #45a049; }
#stock, #codeList, #output, #history {
    margin-top: 15px;
    padding: 15px;
    background: #eee;
    border-radius: 5px;
    white-space: pre;
    font-family: monospace;
}
.codeItem, .historyItem {
    padding: 8px;
    background: #d9f9d9;
    margin-bottom: 5px;
    border-radius: 5px;
}
.historyItem {
    cursor: pointer;
    background: #f9d9d9;
}
.historyItem:hover { background: #f0c0c0; }
.priceSection {
    display: flex;
    gap: 10px;
    flex-wrap: wrap; /* Agar responsif */
}
.priceSection input {
    flex: 1;
    min-width: 0; /* Hindari overflow */
}
</style>
</head>
<body>
<div class="container">

<h2>Kode Redeem Manager</h2>

<!-- Edit Harga -->
<h3>Edit Harga:</h3>
<div class="priceSection">
    <input type="number" id="price7D" placeholder="Harga 7D (Rp)" min="0">
    <input type="number" id="price30D" placeholder="Harga 30D (Rp)" min="0">
</div>
<button onclick="savePrices()">Simpan Harga</button>

<hr>

<!-- Tambah kode -->
<select id="typeSelect">
    <option value="7D">7 Day</option>
    <option value="30D">30 Day</option>
</select>

<textarea id="codeInput" placeholder="Masukkan kode redeem (1 kode per baris)"></textarea>

<input type="number" id="quantityInput" value="1" min="1">

<button onclick="addCode()">Tambah Kode</button>

<hr>

<!-- Ambil kode -->
<h3>Ambil Kode:</h3>

<select id="redeemType">
    <option value="7D">7 Day</option>
    <option value="30D">30 Day</option>
</select>

<input type="number" id="redeemQty" value="1" min="1">

<button onclick="redeemMultiple()">Ambil Kode</button>

<h3>Stock:</h3>
<div id="stock"></div>

<h3>Daftar Kode:</h3>
<div id="codeList"></div>

<h3>Output:</h3>
<div id="output"></div>

<hr>

<h3>Riwayat Output:</h3>
<div id="history"></div>
<button onclick="clearHistory()">Hapus Semua Riwayat</button>

</div>

<script>
console.log("Script loaded"); // Log awal

let codes = [];
let history = [];
let prices = { "7D": 21000, "30D": 61000 }; // Default

try {
    codes = JSON.parse(localStorage.getItem('codes')) || [];
    history = JSON.parse(localStorage.getItem('history')) || [];
    prices = JSON.parse(localStorage.getItem('prices')) || prices;
    console.log("Data loaded from localStorage");
} catch (e) {
    console.error("Error loading localStorage:", e);
    alert("Data localStorage rusak, menggunakan default.");
}

const stockDiv = document.getElementById('stock');
const codeListDiv = document.getElementById('codeList');
const outputDiv = document.getElementById('output');
const historyDiv = document.getElementById('history');
const price7DInput = document.getElementById('price7D');
const price30DInput = document.getElementById('price30D');

if (!stockDiv || !codeListDiv || !outputDiv || !historyDiv || !price7DInput || !price30DInput) {
    console.error("UI elements not found!");
    alert("Error: UI elements tidak ditemukan. Periksa HTML.");
}

function loadPrices() {
    console.log("Loading prices");
    price7DInput.value = prices["7D"];
    price30DInput.value = prices["30D"];
}

function savePrices() {
    console.log("Saving prices");
    const p7 = parseInt(price7DInput.value);
    const p30 = parseInt(price30DInput.value);
    if (p7 > 0 && p30 > 0) {
        prices["7D"] = p7;
        prices["30D"] = p30;
        localStorage.setItem('prices', JSON.stringify(prices));
        alert("Harga berhasil disimpan!");
    } else {
        alert("Harga harus lebih dari 0!");
    }
}

function updateStock() {
    console.log("Updating stock");
    let s7 = codes.filter(c => c.type === "7D").reduce((a,b)=>a+b.quantity, 0);
    let s30 = codes.filter(c => c.type === "30D").reduce((a,b)=>a+b.quantity, 0);
    stockDiv.textContent = `7 Day: ${s7} | 30 Day: ${s30}`;
}

function displayCodes() {
    console.log("Displaying codes");
    updateStock();
    codeListDiv.innerHTML = "";
    codes.forEach(c=>{
        let d = document.createElement("div");
        d.className = "codeItem";
        d.textContent = `${c.type} : ${c.code} (x${c.quantity})`;
        codeListDiv.appendChild(d);
    });
}

function displayHistory() {
    console.log("Displaying history");
    historyDiv.innerHTML = "";
    if (history.length === 0) {
        historyDiv.textContent = "Belum ada riwayat.";
        return;
    }
    history.forEach((h, index) => {
        let d = document.createElement("div");
        d.className = "historyItem";
        d.textContent = `${h.timestamp} - ${h.type} x${h.quantity} (Rp ${h.totalPrice})`;
        d.onclick = () => alert(h.fullOutput);
        historyDiv.appendChild(d);
    });
}

function addCode() {
    console.log("Adding code");
    const type = document.getElementById("typeSelect").value;
    const input = document.getElementById("codeInput").value.trim();
    const qty = parseInt(document.getElementById("quantityInput").value);

    if(!input) return;

    const lines = input.split(/\r?\n/);
    lines.forEach(line=>{
        const code = line.trim();
        if(code){
            let exist = codes.find(c=>c.code===code && c.type===type);
            if(exist) exist.quantity += qty;
            else codes.push({type:type, code:code, quantity:qty});
        }
    });

    localStorage.setItem("codes", JSON.stringify(codes));
    document.getElementById("codeInput").value = "";
    document.getElementById("quantityInput").value = 1;
    displayCodes();
}

function redeemMultiple(){
    console.log("Redeeming codes");
    let type = document.getElementById("redeemType").value;
    let takeQty = parseInt(document.getElementById("redeemQty").value);

    let filtered = [];
    codes.forEach(c=>{
        if(c.type===type){
            for(let i=0;i<c.quantity;i++){
                filtered.push({...c});
            }
        }
    });

    if(takeQty > filtered.length){
        alert(`Stok ${type} kurang! Tersedia ${filtered.length}`);
        return;
    }

    let taken = filtered.slice(0, takeQty);

    let unitPrice = prices[type];
    let totalPrice = (unitPrice*takeQty).toLocaleString("id");

    let codeLines = taken.map(c=>c.code).join("\n               ");

    let fullOutput =
`== ORDER CONFIRMATION ==
Product      : VIP Redeem Code ${type} (Redfinger)
Quantity     : ${takeQty}
Total Price  : Rp ${totalPrice}
Redeem Code  : ${codeLines}

Note:
- Each code can be used for NewCloud and RenewCloud.
- Each code can be used only once.
- No refund unless store error.

Thank you for ordering from Arriab Store!`;

    outputDiv.textContent = fullOutput;

    history.push({
        timestamp: new Date().toLocaleString("id"),
        type: type,
        quantity: takeQty,
        totalPrice: totalPrice,
        fullOutput: fullOutput
    });
    localStorage.setItem("history", JSON.stringify(history));
    displayHistory();

    taken.forEach(t=>{
        let idx = codes.findIndex(c=>c.code===t.code && c.type===type);
        if(idx>=0){
            codes[idx].quantity -= 1;
            if(codes[idx].quantity <= 0) codes.splice(idx, 1);
        }
    });

    localStorage.setItem("codes", JSON.stringify(codes));
    displayCodes();
}

function clearHistory() {
    console.log("Clear history clicked");
    if (confirm("Yakin hapus semua riwayat?")) {
        console.log("Confirmed, clearing history");
        history = [];
        localStorage.setItem("history", JSON.stringify(history));
        displayHistory();
        console.log("History cleared and displayed");
    } else {
        console.log("Cancelled");
    }
}

console.log("Initializing UI");
loadPrices();
displayCodes();
displayHistory();
console.log("UI initialized");
</script>

</body>
</html>
        <h3>3) Export / Import</h3>
        <div class="row">
            <button id="exportJson" class="ghost">Export JSON</button>
            <button id="importJson" class="ghost">Import JSON</button>
            <input type="file" id="importFile" style="display:none" accept="application/json" />
        </div>

        <hr style="margin:12px 0">

        <h3>4) History & logs</h3>
        <div class="small" style="margin-bottom:8px;">Auto log every redeem action. Can export history too.</div>
        <div style="display:flex;gap:8px;margin-bottom:8px;">
            <button id="exportLog" class="ghost">Export Log</button>
            <button id="clearLog" class="ghost">Clear Log</button>
        </div>
        <div id="logList" class="list" style="max-height:200px;"></div>

    </section>

    <!-- RIGHT: stock / redeem / output -->
    <aside class="card">
        <div class="flexBetween">
            <h3>Stock</h3>
            <div class="small stockBar" id="stockBar">-</div>
        </div>

        <h3 style="margin-top:12px">Redeem (take)</h3>
        <div style="display:flex;gap:8px;margin-bottom:8px;">
            <select id="redeemType" style="width:140px">
                <option value="7D">7 Day</option>
                <option value="30D">30 Day</option>
            </select>
            <input type="number" id="redeemQty" value="1" min="1" style="width:110px" />
            <button id="previewRedeem" style="flex:1">Preview</button>
        </div>

        <div style="display:flex;gap:8px;margin-bottom:8px;">
            <button id="redeemBtn">Confirm & Redeem</button>
            <button id="copyCodes" class="ghost">Copy Codes Only</button>
            <button id="printInvoice" class="ghost">Print</button>
        </div>

        <h3 style="margin-top:12px">Available Codes</h3>
        <div class="list" id="codeList" style="margin-bottom:8px;"></div>

        <div style="display:flex;gap:8px;">
            <button id="deleteSelected" class="danger ghost">Delete Selected</button>
            <div style="flex:1"></div>
        </div>

        <hr style="margin:12px 0">

        <h3>Output</h3>
        <div id="output" class="card" style="min-height:160px; padding:12px; background:var(--glass);"></div>
    </aside>

    <footer class="small">Built for Arriab Store â€” client-side. Keep your browser data safe.</footer>
</div>

<!-- Preview modal -->
<div id="modal" class="modal">
    <div class="modalCard">
        <h3>Preview Redeem</h3>
        <pre id="previewText" style="white-space:pre-wrap; max-height:400px; overflow:auto;"></pre>
        <div class="modalFooter">
            <button id="modalCancel" class="ghost">Cancel</button>
            <button id="modalConfirm">Confirm Redeem</button>
        </div>
    </div>
</div>

<script>
/* ---------- Storage keys ---------- */
const KEY_CODES = "arriab_codes_v1";
const KEY_LOGS = "arriab_logs_v1";
const KEY_PRICES = "arriab_prices_v1";
const KEY_THEME = "arriab_theme_v1";

/* ---------- App state ---------- */
let codes = JSON.parse(localStorage.getItem(KEY_CODES) || "[]"); // array of {type,code,quantity}
let logs = JSON.parse(localStorage.getItem(KEY_LOGS) || "[]");
let prices = JSON.parse(localStorage.getItem(KEY_PRICES) || '{"7D":21000,"30D":61000}');
let theme = localStorage.getItem(KEY_THEME) || "light";

/* ---------- Elements ---------- */
const el = id => document.getElementById(id);
const typeSelect = el("typeSelect");
const codeInput = el("codeInput");
const quantityInput = el("quantityInput");
const addBtn = el("addBtn");
const codeListMain = document.querySelectorAll("#codeList")[0]; // left list id collision avoided
const codeListRight = document.querySelectorAll("#codeList")[1]; // right list
const stockBar = el("stockBar");
const price7 = el("price7");
const price30 = el("price30");
const exportJson = el("exportJson");
const importJson = el("importJson");
const importFile = el("importFile");
const deleteDup = el("deleteDup");
const clearAll = el("clearAll");
const logList = el("logList");
const exportLog = el("exportLog");
const clearLog = el("clearLog");
const redeemType = el("redeemType");
const redeemQty = el("redeemQty");
const redeemBtn = el("redeemBtn");
const previewBtn = el("previewRedeem");
const modal = el("modal");
const previewText = el("previewText");
const modalCancel = el("modalCancel");
const modalConfirm = el("modalConfirm");
const outputBox = el("output");
const copyOutputBtn = el("copyOutputBtn");
const copyCodesBtn = el("copyCodes");
const printInvoice = el("printInvoice");
const toggleTheme = el("toggleTheme");
const addClearSelectedBtn = el("deleteSelected");
const deleteSelectedBtn = el("deleteSelected");
const deleteDupBtn = el("deleteDup");
const exportLogBtn = el("exportLog");
const clearLogBtn = el("clearLog");
const importBtnHidden = el("importJson");

/* ---------- Init ---------- */
function init(){
    // load prices
    try{
        prices = JSON.parse(localStorage.getItem(KEY_PRICES) || '{"7D":21000,"30D":61000}');
    }catch(e){
        prices = {"7D":21000,"30D":61000};
    }
    price7.value = prices["7D"];
    price30.value = prices["30D"];

    // theme
    if(theme === "dark"){ document.documentElement.setAttribute("data-theme","dark"); toggleTheme.textContent = "Light"; } 
    else { document.documentElement.removeAttribute("data-theme"); toggleTheme.textContent = "Dark"; }

    renderAll();
}
init();

/* ---------- Helpers ---------- */
function saveCodes(){ localStorage.setItem(KEY_CODES, JSON.stringify(codes)); }
function saveLogs(){ localStorage.setItem(KEY_LOGS, JSON.stringify(logs)); }
function savePrices(){ localStorage.setItem(KEY_PRICES, JSON.stringify(prices)); }
function saveTheme(){ localStorage.setItem(KEY_THEME, theme); }

function normalizeCode(s){
    // safety cleaning: uppercase, trim, replace multiple spaces, keep hyphens
    return s.toUpperCase().replace(/[^\w-]/g,'').replace(/-{2,}/g,'-').trim();
}

function formatRp(n){
    return n.toLocaleString('id');
}

/* ---------- Render ---------- */
function updateStockDisplay(){
    let s7 = codes.filter(c=>c.type==="7D").reduce((a,b)=>a+b.quantity,0);
    let s30 = codes.filter(c=>c.type==="30D").reduce((a,b)=>a+b.quantity,0);
    stockBar.textContent = `7D: ${s7}  |  30D: ${s30}`;
}

function renderCodes(){
    // left small list: codeListMain
    codeListMain.innerHTML = "";
    codes.forEach((c, idx)=>{
        let node = document.createElement("div");
        node.className = "codeItem";
        node.dataset.idx = idx;
        node.innerHTML = `<div style="display:flex;flex-direction:column;">
                <div><strong>${c.type}</strong> &nbsp; <span class="meta">${c.code}</span></div>
                <div class="meta">Quantity: ${c.quantity}</div>
            </div>
            <div style="display:flex;gap:8px;align-items:center">
                <button class="smallBtn" onclick="increase(${idx})">+1</button>
                <button class="smallBtn" onclick="decrease(${idx})">-1</button>
                <button class="smallBtn" onclick="delOne(${idx})">Delete</button>
            </div>`;
        codeListMain.appendChild(node);
    });

    // right list: simpler textual items
    codeListRight.innerHTML = "";
    codes.forEach((c, idx)=>{
        let node = document.createElement("div");
        node.className = "codeItem";
        node.innerHTML = `${c.type} : ${c.code} (x${c.quantity})`;
        codeListRight.appendChild(node);
    });

    updateStockDisplay();
}

function renderLogs(){
    logList.innerHTML = "";
    if(logs.length === 0){
        logList.innerHTML = `<div class="meta">No history yet.</div>`;
        return;
    }
    logs.slice().reverse().forEach(l=>{
        let node = document.createElement("div");
        node.className = "codeItem";
        node.style.flexDirection = "column";
        node.innerHTML = `<div style="display:flex;justify-content:space-between">
            <div><strong>${l.type}</strong> - ${l.qty} pcs</div>
            <div class="meta">${l.when}</div>
            </div>
            <div class="meta">${l.codes.join(", ")}</div>
            <div class="meta">Rp ${formatRp(l.total)}</div>`;
        logList.appendChild(node);
    });
}

function renderAll(){
    renderCodes();
    renderLogs();
}

/* ---------- CRUD helpers ---------- */
function increase(idx){ codes[idx].quantity += 1; saveCodes(); renderAll(); }
function decrease(idx){
    codes[idx].quantity -= 1;
    if(codes[idx].quantity <= 0) codes.splice(idx,1);
    saveCodes(); renderAll();
}
function delOne(idx){
    if(!confirm("Delete this code?")) return;
    codes.splice(idx,1);
    saveCodes(); renderAll();
}

/* ---------- Add codes ---------- */
addBtn.addEventListener("click", ()=>{
    const type = typeSelect.value;
    const qty = Math.max(1, parseInt(quantityInput.value) || 1);
    const raw = codeInput.value.trim();
    if(!raw){ alert("Masukkan kode terlebih dahulu."); return; }

    const lines = raw.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
    let added = 0;
    lines.forEach(l=>{
        const cleaned = normalizeCode(l);
        if(!cleaned) return;
        // safety: if same code exists with same type -> increase qty, otherwise add
        const idx = codes.findIndex(c => c.code === cleaned && c.type === type);
        if(idx >= 0){
            codes[idx].quantity += qty;
        } else {
            codes.push({ type: type, code: cleaned, quantity: qty });
        }
        added++;
    });

    saveCodes();
    codeInput.value = "";
    quantityInput.value = 1;
    renderAll();

    alert(`${added} kode ditambahkan.`);
});

/* ---------- Safety / Dedupe ---------- */
deleteDup.addEventListener("click", ()=>{
    const key = {};
    const before = codes.length;
    codes = codes.filter(c=>{
        const k = c.type + "|" + c.code;
        if(key[k]){ return false; }
        key[k]=true; return true;
    });
    saveCodes();
    renderAll();
    alert(`Duplicates removed. ${before - codes.length} removed.`);
});

clearAll.addEventListener("click", ()=>{
    if(!confirm("Clear all codes? This cannot be undone.")) return;
    codes = [];
    saveCodes();
    renderAll();
});

/* ---------- Export / Import ---------- */
exportJson.addEventListener("click", ()=>{
    const data = { codes, prices, when: new Date().toISOString() };
    const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = "arriab_codes_export.json"; a.click();
    URL.revokeObjectURL(url);
});

importJson.addEventListener("click", ()=> importFile.click());

importFile.addEventListener("change", (e)=>{
    const f = e.target.files[0]; if(!f) return;
    const reader = new FileReader();
    reader.onload = function(ev){
        try{
            const data = JSON.parse(ev.target.result);
            if(Array.isArray(data.codes)){
                // merge safely: add quantities for existing codes
                data.codes.forEach(c=>{
                    if(!c.code || !c.type) return;
                    const cleaned = normalizeCode(c.code);
                    const qty = parseInt(c.quantity) || 1;
                    const idx = codes.findIndex(x=>x.code===cleaned && x.type===c.type);
                    if(idx>=0) codes[idx].quantity += qty;
                    else codes.push({type:c.type, code:cleaned, quantity:qty});
                });
                saveCodes(); renderAll();
                alert("Import berhasil.");
            } else alert("File tidak valid.");
        }catch(err){
            alert("Unable to parse file: " + err);
        }
    };
    reader.readAsText(f);
});

/* ---------- Log export/clear ---------- */
exportLog.addEventListener("click", ()=>{
    const blob = new Blob([JSON.stringify(logs, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = "arriab_logs.json"; a.click();
    URL.revokeObjectURL(url);
});
clearLog.addEventListener("click", ()=>{
    if(!confirm("Clear history logs?")) return;
    logs = [];
    saveLogs();
    renderLogs();
});

/* ---------- Pricing ---------- */
price7.addEventListener("change", ()=>{
    prices["7D"] = Math.max(0, parseInt(price7.value) || 0);
    savePrices();
});
price30.addEventListener("change", ()=>{
    prices["30D"] = Math.max(0, parseInt(price30.value) || 0);
    savePrices();
});

/* ---------- Redeem flow (preview + confirm) ---------- */
function buildFlatListForType(type){
    // returns flattened array of objects for each unit: {type, code}
    const flat = [];
    codes.forEach(c=>{
        if(c.type === type){
            for(let i=0;i<c.quantity;i++) flat.push({type:c.type, code:c.code});
        }
    });
    return flat;
}

previewBtn.addEventListener("click", ()=>{
    const type = redeemType.value;
    const qty = Math.max(1, parseInt(redeemQty.value) || 1);
    const flat = buildFlatListForType(type);
    if(qty > flat.length){ alert(`Stok ${type} tidak cukup (tersedia ${flat.length}).`); return; }

    const taken = flat.slice(0, qty);
    // format output as requested: aligned right of label
    const unit = prices[type] || (type==="7D"?21000:61000);
    const total = unit * qty;

    const codesText = taken.map(x=>x.code).join("\n               ");

    const txt =
`== ORDER CONFIRMATION ==
Product      : VIP Redeem Code ${type} (Redfinger)
Quantity     : ${qty}
Total Price  : Rp ${formatRp(total)}
Redeem Code  : ${codesText}

Note:
- Each code can be used for NewCloud and RenewCloud.
- Each code can be used only once.
- No refund unless store error.

Thank you for ordering from Arriab Store!`;

    previewText.textContent = txt;
    modal.classList.add("show");
});

modalCancel.addEventListener("click", ()=> modal.classList.remove("show"));

modalConfirm.addEventListener("click", ()=>{
    modal.classList.remove("show");
    doRedeem(); // perform actual redeem
});

/* ---------- Redeem implementation
